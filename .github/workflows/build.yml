name: SonarQube
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'
          
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up MAME
        uses: ./.github/actions/mame-setup
        with:
          mame-version: 'mame0284'
          install-path: '/opt/mame'
          
      - name: Verify MAME Installation
        shell: bash
        run: |
          echo "=== Verifying MAME Installation ==="
          echo "MAME executable path: $GAMEVM_WHICH_PATH"
          
          if [ -f "$GAMEVM_WHICH_PATH" ]; then
            echo "✅ MAME is available"
            ls -la "$GAMEVM_WHICH_PATH"
            "$GAMEVM_WHICH_PATH" -version | head -3
          else
            echo "❌ MAME not found at $GAMEVM_WHICH_PATH"
            exit 1
          fi
      - name: Cache SonarQube Cloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache SonarQube Cloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@v4
        with:
          path: ./.sonar/scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner
      - name: Install SonarQube Cloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p ./.sonar/scanner
          dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner
      - name: Install dotnet-coverage
        shell: bash
        run: |
          dotnet tool install --global dotnet-coverage
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
      - name: Verify MAME Installation in Container
        shell: bash
        run: |
          echo "=== Verifying MAME in Container ==="
          echo "MAME executable path: $GAMEVM_WHICH_PATH"
          
          if [ -f "$GAMEVM_WHICH_PATH" ]; then
            echo "✅ MAME is available in container"
            ls -la "$GAMEVM_WHICH_PATH"
            
            # Test MAME version
            if "$GAMEVM_WHICH_PATH" -version; then
              echo "MAME version check successful"
            else
              echo "Warning: Could not get MAME version"
            fi
          else
            echo "❌ MAME not found in container at $GAMEVM_WHICH_PATH"
            echo "Available executables in /opt/mame:"
            if [ -d "/opt/mame" ]; then
              ls -la /opt/mame/
            fi
            exit 1
          fi
          
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        shell: bash
        run: |

          echo "=== Starting SonarQube Scanner Begin ==="
          ./.sonar/scanner/dotnet-sonarscanner begin /k:"kennethcochran_GameVM" /o:"kennethcochran" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.token="$SONAR_TOKEN" /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml"
          echo "SonarQube Scanner Begin exit code: $?"
          if [ $? -ne 0 ]; then 
            echo "ERROR: SonarQube Scanner Begin failed with exit code $?"
            exit 1
          fi
          
          echo "=== Starting dotnet build ==="
          dotnet build --verbosity normal
          echo "dotnet build exit code: $?"
          if [ $? -ne 0 ]; then 
            echo "ERROR: dotnet build failed with exit code $?"
            exit 1
          fi
          
          echo "=== Starting dotnet tool restore ==="
          dotnet tool restore --verbosity normal
          echo "dotnet tool restore exit code: $?"
          if [ $? -ne 0 ]; then 
            echo "ERROR: dotnet tool restore failed with exit code $?"
            exit 1
          fi
          
          echo "=== Starting coverage collection ==="
          dotnet-coverage collect "dotnet test" -f xml -o "coverage.xml" --verbosity normal
          echo "Coverage collection exit code: $?"
          if [ $? -ne 0 ]; then 
            echo "ERROR: Coverage collection failed with exit code $?"
            exit 1
          fi
          
          echo "=== Verifying coverage file ==="
          if [ -f "coverage.xml" ]; then
            echo "Coverage file created successfully"
            ls -la "coverage.xml"
          else
            echo "ERROR: Coverage file not found"
            exit 1
          fi
          
          echo "=== Starting SonarQube Scanner End ==="
          ./.sonar/scanner/dotnet-sonarscanner end /d:sonar.token="$SONAR_TOKEN"
          echo "SonarQube Scanner End exit code: $?"
          if [ $? -ne 0 ]; then 
            echo "ERROR: SonarQube Scanner End failed with exit code $?"
            exit 1
          fi
          
          echo "=== Build and analyze completed successfully ==="
          
      - name: Check SonarQube Quality Gate
        shell: bash
        run: |
          echo "=== Checking SonarQube Quality Gate ==="
          
          # Wait for SonarQube processing
          echo "Waiting 30 seconds for SonarQube processing..."
          sleep 30
          
          # Get the latest analysis for the project
          PROJECT_KEY="kennethcochran_GameVM"
          URL="https://sonarcloud.io/api/qualitygates/project_status?projectKey=$PROJECT_KEY"
          
          # Set up headers
          AUTH_HEADER="Authorization: Bearer $SONAR_TOKEN"
          
          echo "Checking quality gate at: $URL"
          
          if response=$(curl -s -f -H "$AUTH_HEADER" "$URL"); then
            echo "Quality Gate response received"
            
            # Extract status using jq (if available) or grep
            if command -v jq &> /dev/null; then
              STATUS=$(echo "$response" | jq -r '.projectStatus.status')
              echo "Quality Gate Status: $STATUS"
              
              if [ "$STATUS" = "ERROR" ]; then
                echo "Quality Gate failed!"
                echo "Failed conditions:"
                echo "$response" | jq -r '.projectStatus.conditions[] | select(.status == "ERROR") | "- \(.metricKey): Expected \(.errorThreshold), got \(.actualValue)"'
                exit 1
              else
                echo "Quality Gate passed!"
              fi
            else
              echo "jq not available, showing raw response:"
              echo "$response"
              
              # Simple grep for status
              if echo "$response" | grep -q '"status":"ERROR"'; then
                echo "Quality Gate failed!"
                exit 1
              else
                echo "Quality Gate passed!"
              fi
            fi
          else
            echo "Error checking quality gate: HTTP request failed"
            exit 1
          fi