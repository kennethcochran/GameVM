#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

## husky task runner examples -------------------
## Note : for local installation use 'dotnet' prefix. e.g. 'dotnet husky'

## run all tasks
#husky run

### run all tasks with group: 'group-name'
#husky run --group group-name

## run task with name: 'task-name'
#husky run --name task-name

## pass hook arguments to task
#husky run --args "$1" "$2"

## or put your custom commands -------------------
#echo 'Husky.Net is awesome!'

# Run CRAP score quality gate
echo "üîç Running CRAP Score Quality Gate..."
dotnet test --collect:"XPlat Code Coverage" --logger:"trx;LogFileName=crap-check.trx" --results-directory ./TestResults --no-build

if [ $? -eq 0 ]; then
    echo "‚úÖ Tests passed, checking CRAP scores..."
    dotnet tool run reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:"TestResults/crap-check" -reporttypes:JsonSummary
    
    if [ -f "TestResults/crap-check/Summary.json" ]; then
        pwsh scripts/Check-CrapGate.ps1 -ReportPath "TestResults/crap-check/Summary.json" -Threshold 30
    else
        echo "‚ùå Coverage report not generated"
        exit 1
    fi
else
    echo "‚ùå Tests failed, skipping CRAP check"
    exit 1
fi
